#!/bin/bash
echo 'Running RAVEN tests ...'

SCRIPT_NAME=`readlink $0`
if test -x "$SCRIPT_NAME";
then
    SCRIPT_DIRNAME=`dirname $SCRIPT_NAME`
else
    SCRIPT_DIRNAME=`dirname $0`
fi
SCRIPT_DIR=`(cd $SCRIPT_DIRNAME; pwd)`

SKIP_CONDA=1 # 0 for skipping conda, 1 for not skipping
# source read ravenrc script
RAVEN_RC_SCRIPT=$SCRIPT_DIR/scripts/read_ravenrc.sh
RAVEN_RC_SCRIPT="${RAVEN_RC_SCRIPT//\\//}"
source $RAVEN_RC_SCRIPT
INSTALLATION_MANAGER=$(read_ravenrc "INSTALLATION_MANAGER")
if [[ "$INSTALLATION_MANAGER" == "PIP" ]];
  then
  SKIP_CONDA=0
else
  # conda
  SKIP_CONDA=1
fi

ARGS=()
for A in "$@"; do
    case $A in
        --skip-conda)
            SKIP_CONDA=0
            ;;
        *)
            ARGS+=("$A")
            ;;
    esac
done
echo 'Loading libraries ...'
if [[ ! $SKIP_CONDA == 0 ]]; then
    source $SCRIPT_DIR/scripts/establish_conda_env.sh --load
else
    source $SCRIPT_DIR/scripts/establish_conda_env.sh --load --installation-manager PIP
    #PYTHON_COMMAND=${PYTHON_COMMAND:=python}
fi

for A in "$@"; do
    case $A in
        --library_report | --library-report)
            $PYTHON_COMMAND $SCRIPT_DIR/scripts/library_report
            exit
            ;;
    esac
done

# run the tests
# -> First RAVEN
# -> Then each plugin in turn
echo
echo "********************************************************************************"
echo
echo 'Running RAVEN tests ...'

# success/fail storage
#   Names of successful test sets are stored in PASSED
#   Names of failed test sets are stored in FAILED

# run RAVEN tests
$PYTHON_COMMAND $SCRIPT_DIR/rook/main.py --config-file=$SCRIPT_DIR/developer_tools/rook.ini "${ARGS[@]}"
# store return codes individually (rc) and combined (ALL_PASS)
rc=$?
ALL_PASS=$rc
if [[ $rc != 0 ]]; then
    echo ' ... there were failed RAVEN tests!'
    FAILED=( "RAVEN" )
else
    echo ' ... RAVEN tests passed successfully.'
    PASSED=( "RAVEN" )
fi

# Now run the plugin tests
echo 'Loading plugin tests ...'
PLUGINS=$($PYTHON_COMMAND $SCRIPT_DIR/scripts/plugin_handler.py -l)
for P in $PLUGINS; do
  LOCATION=$($PYTHON_COMMAND $SCRIPT_DIR/scripts/plugin_handler.py -f $P)/tests
  # TODO extend config to use RAVEN and PLUGIN config options without redoing all tests
  echo
  echo "********************************************************************************"
  echo
  echo Starting tests for plugin "$P" ...
  $PYTHON_COMMAND $SCRIPT_DIR/rook/main.py --test-dir $LOCATION "${ARGS[@]}"
  rc=$?
  ALL_PASS=$(($ALL_PASS + $rc))
  if [[ $rc != 0 ]]; then
    echo  ... there were failed tests for plugin "$P"!
    FAILED=( "${FAILED[@]}" "$P" )
  else
    echo Tests passed for plugin "$P".
    PASSED=( "${PASSED[@]}" "$P" )
  fi
done

## FINISHED running tests

# report results
echo
echo "********************************************************************************"
echo
if [[ $ALL_PASS != 0 ]]; then
  echo  ... there were failed tests!
  echo The following tests passed: ${PASSED[@]}
  echo The following tests failed: ${FAILED[@]}
  exit $ALL_PASS
else
  echo Tested: ${PASSED[@]}
  echo ... tests passed!
fi

